@using MovManagerr.Models

<h2 class="content-block">Accueil</h2>


@(Html.DevExtreme().Toolbar()
    .Items(items => {

        items.Add()
                .Location(ToolbarItemLocation.Center)
                .Widget(w =>
                    w.Button()
                        .Text("Search new movies (2)")
                        .Icon("plus")
                        .ID("AddLikeNewMovieButton")
                );

            items.Add()
                .Location(ToolbarItemLocation.Center)
                .Widget(w =>
                    w.Button()
                        .Icon("trash")
                        .Text("Delete Tmdb movies")
                        .ID("DeleteFavoriteMoviesButton")
                );


              items.Add()
                .Location(ToolbarItemLocation.Center)
                .Widget(w =>
                    w.Button()
                        .Icon("sorted")
                        .Text("Sync Movies")
                        .ID("SyncMovieButton")
                );

             items.Add()
                .Location(ToolbarItemLocation.Center)
                .Widget(w =>
                    w.Button()
                        .Icon("trash")
                        .Text("Delete bad movies")
                        .ID("deleteBadMovies")
                );
    })
)


@(Html.DevExtreme().DataGrid<MovieDirectorySpec>()
    .ID("grid-container")
    .ElementAttr(new { @class = "dx-card wide-card" })
    .DataSource(d => d.Mvc().Controller("MovieData").LoadAction("Get").Key("Id"))
    .ShowBorders(false)
    .ColumnAutoWidth(true)
    .RowAlternationEnabled(true)
    .AllowColumnResizing(true)
    .ColumnHidingEnabled(true)
    .RemoteOperations(true)
    .RepaintChangesOnly(true)
    .Editing(e => e
        .Mode(GridEditMode.Batch)
        .AllowDeleting(true)
    )
    .OnSaving("onSaving")
    .Columns(columns => {
       columns.AddFor(m => m.Movie.PosterPath)
            .Width(100)
            .AllowFiltering(false)
            .AllowSorting(false)
            .Caption("")
            .CellTemplate(@<text>
        <div>
            <img style="width:90px; height:auto" src="https://image.tmdb.org/t/p/w200/<%- value %>" alt="" />
        </div>
    </text>);
        columns.AddFor(m => m.Movie.Title).Caption("Titre du film").Width(200);
        columns.AddFor(m => m.Gb).Caption("Taille du fichier").Width(100);
        columns.AddFor(m => m.FullPath).Caption("Chemin du film").MinWidth(400).AllowHiding(false);
    })
    .Paging(p => p.PageSize(10))
    .Pager(p => p
        .ShowPageSizeSelector(true)
        .AllowedPageSizes(new[] { 5, 10, 20, 50, 100 })
        .ShowInfo(true)
    )
)


<script>
    function onSaving(e) {
        e.cancel = true;

        if (e.changes.length) {
            e.promise = sendBatchRequest('@Url.RouteUrl(new { controller = "MovieData", action = "Batch" })', e.changes).done(() => {
                e.component.refresh(true).done(() => {
                    e.component.cancelEditData();
                });
            });
        }
    }


    function sendBatchRequest(url, changes) {
        var d = $.Deferred();

        $.ajax(url, {
            method: "POST",
            data: JSON.stringify(changes),
            cache: false,
            contentType: 'application/json',
            xhrFields: { withCredentials: true }
        }).done(d.resolve).fail(function(xhr) {
            d.reject(xhr.responseJSON ? xhr.responseJSON.Message : xhr.statusText);
        });

        return d.promise();
    }

    $(function() {
        $("#deleteBadMovies").dxButton({
            onClick: function() {
                callAction("DeleteBadMovies");
            }
        });

        $("#SyncMovieButton").dxButton({
            onClick: function() {
                callAction("SyncFolderWithTmdb");
            }
        });

        $("#DeleteFavoriteMoviesButton").dxButton({
            onClick: function() {
                callAction("DeleteFavoriteMovies");
            }
        });

        $("#AddLikeNewMovieButton").dxButton({
            onClick: function() {
                callAction("LikeNewMovie");
            }
        });
    });


    function callAction(url) {
        var result = DevExpress.ui.dialog.confirm("<i>Confirm actions : " + url+ " ?</i>", "Confirm");
        result.done(function(dialogResult) {

            if (dialogResult) {
                $.ajax({
                    url: "/MovieTask/" + url,
                    type: "POST",
                    success: function(data) {
                        DevExpress.ui.notify(data.Message, "success");
                    },
                    error: function(data) {
                        DevExpress.ui.notify(data.Message, "error");
                    }
                });
            }
        });
    }
</script>

